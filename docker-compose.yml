version: '3.8'

networks:
  entrance-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  kafka-data:
  traefik-certs:

services:
  # ========================================
  # TRAEFIK - Reverse Proxy HTTPS/TLS
  # ========================================
  traefik:
    image: traefik:v2.10
    container_name: entrance-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
      - "8090:8080"  # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./docker/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./docker/traefik/certs:/certs:ro
      - traefik-certs:/letsencrypt
    networks:
      - entrance-network
    restart: unless-stopped

  # ========================================
  # INFRASTRUCTURE - Database, Cache, Messaging
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: entrance-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-entrance_db}
      POSTGRES_USER: ${POSTGRES_USER:-entrance_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-entrance_password}
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_SHARED_BUFFERS: 256MB
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - entrance-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-entrance_user} -d ${POSTGRES_DB:-entrance_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: entrance-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password} --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - entrance-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: entrance-kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: entrance-kafka-cluster-01
    ports:
      - "9092:9092"
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - entrance-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ========================================
  # BACKEND SERVICES - Micronaut
  # ========================================

  # 1. Static Server Backend (Port 8080)
  static-server-backend:
    build:
      context: ./backend/static-server-backend
      dockerfile: Dockerfile
    container_name: entrance-static-server
    environment:
      MICRONAUT_ENVIRONMENTS: prod
      MICRONAUT_SERVER_PORT: 8080
      FRONTEND_BUILD_PATH: /app/frontend/dist
    ports:
      - "8080:8080"
    volumes:
      - ./frontend/dist:/app/frontend/dist:ro
    networks:
      - entrance-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.static-server.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/`)"
      - "traefik.http.routers.static-server.entrypoints=websecure"
      - "traefik.http.routers.static-server.tls=true"
      - "traefik.http.routers.static-server.priority=1"
      - "traefik.http.services.static-server.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - traefik
    restart: unless-stopped

  # 2. Core Operational Backend (Port 8081)
  core-operational-backend:
    build:
      context: ./backend/core-operational-backend
      dockerfile: Dockerfile
    container_name: entrance-core-operational
    environment:
      MICRONAUT_ENVIRONMENTS: prod
      MICRONAUT_SERVER_PORT: 8081
      DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-entrance_db}
      DATASOURCE_USERNAME: ${POSTGRES_USER:-entrance_user}
      DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-entrance_password}
      REDIS_URI: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      JWT_SECRET: ${JWT_SECRET:-entrance_cockpit_super_secret_key_change_in_production}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-3600}
    ports:
      - "8081:8081"
    networks:
      - entrance-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.core-operational.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api/auth`, `/api/users`, `/api/badges`, `/api/entrance/activate`, `/api/entrance/reject`)"
      - "traefik.http.routers.core-operational.entrypoints=websecure"
      - "traefik.http.routers.core-operational.tls=true"
      - "traefik.http.routers.core-operational.priority=100"
      - "traefik.http.services.core-operational.loadbalancer.server.port=8081"
      - "traefik.http.middlewares.core-operational-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.core-operational-ratelimit.ratelimit.burst=50"
      - "traefik.http.routers.core-operational.middlewares=core-operational-ratelimit"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      traefik:
        condition: service_started
    restart: unless-stopped

  # 3. Cache Loading Backend (Port 8082)
  cache-loading-backend:
    build:
      context: ./backend/cache-loading-backend
      dockerfile: Dockerfile
    container_name: entrance-cache-loading
    environment:
      MICRONAUT_ENVIRONMENTS: prod
      MICRONAUT_SERVER_PORT: 8082
      DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-entrance_db}
      DATASOURCE_USERNAME: ${POSTGRES_USER:-entrance_user}
      DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-entrance_password}
      REDIS_URI: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      CACHE_SYNC_INTERVAL: ${CACHE_SYNC_INTERVAL:-300}
    ports:
      - "8082:8082"
    networks:
      - entrance-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cache-loading.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api/cache`)"
      - "traefik.http.routers.cache-loading.entrypoints=websecure"
      - "traefik.http.routers.cache-loading.tls=true"
      - "traefik.http.routers.cache-loading.priority=100"
      - "traefik.http.services.cache-loading.loadbalancer.server.port=8082"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      traefik:
        condition: service_started
    restart: unless-stopped

  # 4. Entrance Cockpit Backend (Port 8083)
  entrance-cockpit-backend:
    build:
      context: ./backend/entrance-cockpit-backend
      dockerfile: Dockerfile
    container_name: entrance-cockpit
    environment:
      MICRONAUT_ENVIRONMENTS: prod
      MICRONAUT_SERVER_PORT: 8083
      DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-entrance_db}
      DATASOURCE_USERNAME: ${POSTGRES_USER:-entrance_user}
      DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-entrance_password}
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      JWT_SECRET: ${JWT_SECRET:-entrance_cockpit_super_secret_key_change_in_production}
    ports:
      - "8083:8083"
    networks:
      - entrance-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.entrance-cockpit.rule=Host(`${DOMAIN:-localhost}`) && (PathPrefix(`/api/entrance`) || PathPrefix(`/ws/entrance-realtime`))"
      - "traefik.http.routers.entrance-cockpit.entrypoints=websecure"
      - "traefik.http.routers.entrance-cockpit.tls=true"
      - "traefik.http.routers.entrance-cockpit.priority=100"
      - "traefik.http.services.entrance-cockpit.loadbalancer.server.port=8083"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      traefik:
        condition: service_started
    restart: unless-stopped

  # 5. Telemetry Messaging Backend (Port 8084)
  telemetry-messaging-backend:
    build:
      context: ./backend/telemetry-messaging-backend
      dockerfile: Dockerfile
    container_name: entrance-telemetry
    environment:
      MICRONAUT_ENVIRONMENTS: prod
      MICRONAUT_SERVER_PORT: 8084
      DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-entrance_db}
      DATASOURCE_USERNAME: ${POSTGRES_USER:-entrance_user}
      DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-entrance_password}
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MQTT_BROKER_URL: ${MQTT_BROKER_URL:-tcp://mosquitto:1883}
      JWT_SECRET: ${JWT_SECRET:-entrance_cockpit_super_secret_key_change_in_production}
    ports:
      - "8084:8084"
    networks:
      - entrance-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telemetry.rule=Host(`${DOMAIN:-localhost}`) && (PathPrefix(`/api/telemetry`) || PathPrefix(`/api/door-locks`) || PathPrefix(`/ws/telemetry`) || PathPrefix(`/ws/door-events`))"
      - "traefik.http.routers.telemetry.entrypoints=websecure"
      - "traefik.http.routers.telemetry.tls=true"
      - "traefik.http.routers.telemetry.priority=100"
      - "traefik.http.services.telemetry.loadbalancer.server.port=8084"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      traefik:
        condition: service_started
    restart: unless-stopped

  # ========================================
  # IOT SIMULATOR
  # ========================================
  iot-simulator:
    build:
      context: ./iot-simulator
      dockerfile: Dockerfile
    container_name: entrance-iot-simulator
    environment:
      ENTRANCE_COCKPIT_API: https://traefik/api/entrance/badge-scan
      TELEMETRY_API: https://traefik/api/telemetry/sensors
      SIMULATION_INTERVAL: ${SIMULATION_INTERVAL:-10}
    networks:
      - entrance-network
    depends_on:
      - entrance-cockpit-backend
      - telemetry-messaging-backend
    restart: unless-stopped
